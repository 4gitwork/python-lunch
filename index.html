<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POSæ”¶éŠ€ç³»çµ±-é€²éšäº’å‹•(å¯ç·¨è¼¯ç”¢å“/å¤šä»˜æ¬¾/èªéŸ³é–‹é—œ)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;}
        .pos-container {max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden;}
        .header {background: linear-gradient(45deg, #2c3e50, #34495e); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center;}
        .logo { font-size: 24px; font-weight: bold;}
        .datetime { font-size: 14px; opacity: 0.9;}
        .main-content { display: grid; grid-template-columns: 2fr 1fr; gap: 0; min-height: 80vh;}
        .left-panel { padding: 30px; background: #f8f9fa;}
        .right-panel { background: white; border-left: 1px solid #e0e0e0; display: flex; flex-direction: column;}
        .products-section h2 { color: #2c3e50; margin-bottom: 20px; font-size: 20px;}
        .product-categories { display: flex; gap: 10px; margin-bottom: 20px;}
        .category-btn { padding: 8px 16px; border: 2px solid #3498db; background: white; color: #3498db; border-radius: 25px; cursor: pointer; transition: all 0.3s; font-size: 14px;}
        .category-btn.active, .category-btn:hover { background: #3498db; color: white;}
        .product-search-box { margin-bottom: 15px;}
        .product-search-box input { width: 70%; padding: 8px 12px; border: 1.5px solid #bbb; border-radius: 20px; font-size: 15px; outline: none; transition: border 0.2s;}
        .product-search-box input:focus { border: 1.5px solid #3498db;}
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;}
        .product-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); position: relative; transition: all 0.3s; border: 2px solid transparent;}
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); border-color: #3498db;}
        .product-name { font-weight: bold; color: #2c3e50; margin-bottom: 8px; font-size: 16px;}
        .product-price { color: #e74c3c; font-size: 18px; font-weight: bold; margin-bottom: 8px;}
        .product-stock { font-size: 12px; color: #7f8c8d;}
        .stock-low { color: #e74c3c;}
        .stock-out { color: #c0392b; font-weight: bold;}
        .product-actions { position: absolute; top: 8px; right: 8px; display: flex; gap: 4px;}
        .edit-btn, .del-btn { background: #fff; border: 1px solid #bbb; border-radius: 5px; padding: 2px 8px; font-size: 13px; cursor: pointer;}
        .edit-btn:hover { background: #f1c40f; color: #fff; border-color: #f1c40f;}
        .del-btn:hover { background: #e74c3c; color: #fff; border-color: #e74c3c;}
        .add-product-btn { margin-bottom: 18px; background: #27ae60; color: #fff; border: none; border-radius: 20px; padding: 8px 24px; cursor: pointer; font-size: 16px;}
        .add-product-btn:hover { background: #219150;}
        .cart-section { padding: 30px; flex: 1;}
        .cart-header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; color: #2c3e50;}
        .cart-items { max-height: 300px; overflow-y: auto; margin-bottom: 20px;}
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid #ecf0f1; border-radius: 10px; margin-bottom: 10px; background: #f8f9fa; cursor: grab;}
        .cart-item.dragging { opacity: 0.4;}
        .item-info { flex: 1; cursor: grab;}
        .item-name { font-weight: bold; color: #2c3e50;}
        .item-price { color: #7f8c8d; font-size: 14px;}
        .quantity-controls { display: flex; align-items: center; gap: 10px;}
        .qty-btn { width: 30px; height: 30px; border: none; background: #3498db; color: white; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;}
        .qty-btn:hover { background: #2980b9;}
        .quantity { font-weight: bold; min-width: 30px; text-align: center;}
        .remove-btn { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;}
        .remove-btn:hover { background: #c0392b;}
        .subtotal-section { padding: 20px 30px; border-top: 2px solid #ecf0f1; background: #f8f9fa;}
        .subtotal-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 16px;}
        .total-row { display: flex; justify-content: space-between; font-size: 20px; font-weight: bold; color: #2c3e50; border-top: 2px solid #bdc3c7; padding-top: 10px; margin-top: 10px;}
        .discount-applied { color: #27ae60;}
        .member-section { padding: 20px 30px; border-top: 2px solid #ecf0f1; background: white;}
        .member-card { background: linear-gradient(45deg, #f39c12, #e67e22); color: white; padding: 20px; border-radius: 15px; margin-bottom: 15px;}
        .member-info { display: flex; justify-content: space-between; align-items: center;}
        .member-name { font-size: 18px; font-weight: bold;}
        .member-level { background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px; font-size: 12px;}
        .member-details { margin-top: 10px; font-size: 14px; opacity: 0.9;}
        .member-login { text-align: center; color: #7f8c8d; padding: 20px;}
        .login-btn { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; margin-top: 10px;}
        .login-btn:hover { background: #2980b9;}
        .promotions-section { padding: 20px 30px; border-top: 2px solid #ecf0f1; background: #f8f9fa;}
        .promotion-item { background: linear-gradient(45deg, #e74c3c, #c0392b); color: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; animation: pulse 2s infinite;}
        .promotion-title { font-weight: bold; margin-bottom: 5px;}
        .promotion-desc { font-size: 12px; opacity: 0.9;}
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);} 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0);} 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);}}
        .checkout-section { padding: 20px 30px; background: white;}
        .checkout-btn { width: 100%; background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; border: none; padding: 15px; font-size: 18px; font-weight: bold; border-radius: 10px; cursor: pointer; transition: all 0.3s;}
        .checkout-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);}
        .checkout-btn:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none;}
        .empty-cart { text-align: center; color: #7f8c8d; padding: 40px 20px;}
        .empty-cart-icon { font-size: 48px; margin-bottom: 15px; opacity: 0.5;}
        /* ä»˜æ¬¾æ–¹å¼æŒ‰éˆ• */
        .payment-methods { display: flex; gap: 10px; margin: 15px 0;}
        .pay-method-btn { padding: 8px 16px; border-radius: 18px; border: 2px solid #34495e; background: white; color: #34495e; cursor: pointer; font-size: 15px;}
        .pay-method-btn.active, .pay-method-btn:hover { background: #34495e; color: #fff;}
        /* åˆ—å°å°ˆç”¨æ¨£å¼ */
        @media print { body * { visibility: hidden !important;} #print-area, #print-area * { visibility: visible !important;} #print-area { position: absolute; left: 0; top: 0; width: 100vw; background: white;}}
        /* Modal */
        .modal-bg { position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; z-index: 99;}
        .modal { background: #fff; border-radius: 12px; padding: 24px; min-width: 340px; box-shadow: 0 8px 32px rgba(0,0,0,0.21);}
        .modal label { display: block; margin-bottom: 5px;}
        .modal input, .modal select { width: 100%; padding: 8px 10px; margin-bottom: 14px; border: 1.2px solid #bbb; border-radius: 6px;}
        .modal-actions { text-align: right;}
        .modal-actions button { margin-left: 10px; padding: 7px 18px; border-radius: 8px; border: none; font-size: 15px;}
        .modal-actions .cancel-btn { background: #bdc3c7; color: #fff;}
        .modal-actions .ok-btn { background: #27ae60; color: #fff;}
        /* èªéŸ³é–‹é—œ */
        .speech-toggle { position: absolute; right: 35px; top: 20px; z-index: 10;}
        .speech-toggle label { font-size: 15px; color: #fff; background: #27ae60; border-radius: 12px; padding: 3px 14px; cursor: pointer;}
        .speech-toggle input[type="checkbox"] { margin-right: 5px;}
        @media (max-width: 768px) { .main-content { grid-template-columns: 1fr;} .products-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));} .pos-container { margin: 10px; border-radius: 10px;}}
    </style>
</head>
<body>
    <div class="pos-container">
        <div class="header">
            <div class="logo">ğŸª POSæ”¶éŠ€ç³»çµ±</div>
            <div class="speech-toggle">
                <label><input type="checkbox" id="speechSwitch" checked>èªéŸ³æç¤º</label>
            </div>
            <div class="datetime" id="datetime"></div>
        </div>
        <div class="main-content">
            <!-- å·¦å´ï¼šç”¢å“é¸æ“‡å€åŸŸ -->
            <div class="left-panel">
                <div class="products-section">
                    <h2>ğŸ“¦ ç”¢å“é¸æ“‡</h2>
                    <button class="add-product-btn" onclick="showProductModal()">ï¼‹ æ–°å¢å•†å“</button>
                    <div class="product-categories">
                        <button class="category-btn active" onclick="filterProducts('all', event)">å…¨éƒ¨</button>
                        <button class="category-btn" onclick="filterProducts('é£²å“', event)">é£²å“</button>
                        <button class="category-btn" onclick="filterProducts('ç”œé»', event)">ç”œé»</button>
                        <button class="category-btn" onclick="filterProducts('ä¸»é£Ÿ', event)">ä¸»é£Ÿ</button>
                        <button class="category-btn" onclick="filterProducts('å°é£Ÿ', event)">å°é£Ÿ</button>
                    </div>
                    <div class="product-search-box">
                        <input type="text" id="barcodeInput" placeholder="è«‹æƒæ¢ç¢¼æˆ–è¼¸å…¥å•†å“é—œéµå­—">
                    </div>
                    <div class="products-grid" id="productsGrid"></div>
                </div>
            </div>
            <!-- å³å´ï¼šè³¼ç‰©è»Šå’Œå…¶ä»–è³‡è¨Š -->
            <div class="right-panel">
                <div class="cart-section">
                    <div class="cart-header">
                        <span>ğŸ›’</span>
                        <h3>è³¼ç‰©è»Š</h3>
                        <span id="cartCount">(0)</span>
                    </div>
                    <div class="cart-items" id="cartItems"></div>
                </div>
                <div class="subtotal-section">
                    <div class="subtotal-row">
                        <span>å°è¨ˆï¼š</span>
                        <span id="subtotal">NT$0</span>
                    </div>
                    <div class="subtotal-row">
                        <span>æŠ˜æ‰£ï¼š</span>
                        <span id="discount" class="discount-applied">-NT$0</span>
                    </div>
                    <div class="subtotal-row">
                        <span>ç¨…é‡‘ï¼š</span>
                        <span id="tax">NT$0</span>
                    </div>
                    <div class="total-row">
                        <span>ç¸½è¨ˆï¼š</span>
                        <span id="total">NT$0</span>
                    </div>
                </div>
                <div class="payment-methods">
                    <button class="pay-method-btn active" onclick="selectPayment('ç¾é‡‘', this)">ç¾é‡‘</button>
                    <button class="pay-method-btn" onclick="selectPayment('ç¦®åˆ¸', this)">ç¦®åˆ¸</button>
                    <button class="pay-method-btn" onclick="selectPayment('ä¿¡ç”¨å¡', this)">ä¿¡ç”¨å¡</button>
                </div>
                <div class="member-section">
                    <h4>ğŸ‘¤ æœƒå“¡è³‡è¨Š</h4>
                    <div id="memberInfo">
                        <div class="member-login">
                            <p>å°šæœªç™»å…¥æœƒå“¡</p>
                            <button class="login-btn" onclick="loginMember()">æœƒå“¡ç™»å…¥</button>
                        </div>
                    </div>
                </div>
                <div class="promotions-section">
                    <h4>ğŸ‰ å„ªæƒ æ´»å‹•</h4>
                    <div id="promotions"></div>
                </div>
                <div class="checkout-section">
                    <button class="checkout-btn" id="checkoutBtn" onclick="checkout()" disabled>ğŸ’³ çµå¸³ä»˜æ¬¾</button>
                    <button class="checkout-btn" style="margin-top:10px;background:#34495e;" onclick="printReceipt()">ğŸ–¨ï¸ åˆ—å°æ˜ç´°</button>
                </div>
            </div>
        </div>
    </div>
    <div id="print-area" style="display:none;">
        <h2>POS è³¼ç‰©æ˜ç´°</h2>
        <div id="print-cart-list"></div>
        <div id="print-total"></div>
        <p style="margin-top:20px;">æ„Ÿè¬æ‚¨çš„æ¶ˆè²»ï¼</p>
    </div>
    <!-- Modal -->
    <div id="modalBg" class="modal-bg" style="display:none;">
        <div id="modal" class="modal"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <script>
        // ç”¢å“æ•¸æ“š
        let products = [
            { id: 1, name: 'ç¶“å…¸ç¾å¼å’–å•¡', price: 120, stock: 25, category: 'é£²å“' },
            { id: 2, name: 'æ‹¿éµå’–å•¡', price: 150, stock: 18, category: 'é£²å“' },
            { id: 3, name: 'å¡å¸ƒå¥‡è«¾', price: 140, stock: 20, category: 'é£²å“' },
            { id: 4, name: 'å·§å…‹åŠ›è›‹ç³•', price: 180, stock: 8, category: 'ç”œé»' },
            { id: 5, name: 'èµ·å¸è›‹ç³•', price: 200, stock: 5, category: 'ç”œé»' },
            { id: 6, name: 'ææ‹‰ç±³è˜‡', price: 220, stock: 3, category: 'ç”œé»' },
            { id: 7, name: 'ç¶“å…¸æ¼¢å ¡', price: 280, stock: 12, category: 'ä¸»é£Ÿ' },
            { id: 8, name: 'ç‚¸é›å¥—é¤', price: 320, stock: 15, category: 'ä¸»é£Ÿ' },
            { id: 9, name: 'ç¾©å¤§åˆ©éºµ', price: 250, stock: 10, category: 'ä¸»é£Ÿ' },
            { id: 10, name: 'è–¯æ¢', price: 80, stock: 30, category: 'å°é£Ÿ' },
            { id: 11, name: 'æ´‹è”¥åœˆ', price: 90, stock: 20, category: 'å°é£Ÿ' },
            { id: 12, name: 'é›å¡Š', price: 100, stock: 25, category: 'å°é£Ÿ' }
        ];
        let cart = [];
        let currentMember = null;
        let currentProductFilter = 'all';
        let currentSearch = '';
        let paymentMethod = 'ç¾é‡‘';
        let speechOn = true;
        let editingProductId = null;
        const memberData = {
            id: 'M001',
            name: 'ç‹å°æ˜',
            phone: '0912-345-678',
            points: 1250,
            level: 'VIP',
            discount: 0.1
        };
        const promotions = [
            { id: 1, title: 'æ»¿500é€50', description: 'æ¶ˆè²»æ»¿500å…ƒå³é€50å…ƒæŠ˜åƒ¹åˆ¸', active: true },
            { id: 2, title: 'VIPæœƒå“¡9æŠ˜', description: 'VIPæœƒå“¡äº«å…¨å“é …9æŠ˜å„ªæƒ ', active: true },
            { id: 3, title: 'è²·äºŒé€ä¸€', description: 'é£²å“è²·äºŒé€ä¸€ï¼ˆé™é€±æœ«ï¼‰', active: false }
        ];
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            renderProducts();
            renderPromotions();
            updateCartDisplay();
            document.getElementById('barcodeInput').addEventListener('input', function(e){
                currentSearch = e.target.value.trim();
                renderProducts(currentProductFilter, currentSearch);
            });
            new Sortable(document.getElementById('cartItems'), {
                animation: 150,
                handle: '.item-info',
                onEnd: function (evt) {
                    const newOrder = Array.from(document.querySelectorAll('#cartItems .cart-item')).map(el => Number(el.dataset.id));
                    cart = newOrder.map(id => cart.find(item => item.id === id));
                    updateCartDisplay();
                    speak('è³¼ç‰©è»Šå·²é‡æ–°æ’åº');
                }
            });
            document.getElementById('speechSwitch').addEventListener('change', function(e){
                speechOn = e.target.checked;
            });
        });
        function updateDateTime() {
            const now = new Date();
            const dateTimeString = now.toLocaleDateString('zh-TW') + ' ' + now.toLocaleTimeString('zh-TW');
            document.getElementById('datetime').textContent = dateTimeString;
        }
        function renderProducts(filter = 'all', search = '') {
            currentProductFilter = filter;
            const grid = document.getElementById('productsGrid');
            let filteredProducts = products;
            if (filter && filter !== 'all') filteredProducts = filteredProducts.filter(p => p.category === filter);
            if (search) filteredProducts = filteredProducts.filter(p => p.name.includes(search));
            grid.innerHTML = filteredProducts.map(product => `
                <div class="product-card">
                    <div class="product-actions">
                        <button class="edit-btn" onclick="event.stopPropagation(); editProduct(${product.id})">ç·¨è¼¯</button>
                        <button class="del-btn" onclick="event.stopPropagation(); delProduct(${product.id})">åˆªé™¤</button>
                    </div>
                    <div onclick="addToCart(${product.id})">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">NT$${product.price}</div>
                        <div class="product-stock ${getStockClass(product.stock)}">
                            åº«å­˜ï¼š${product.stock}ä»¶
                            ${product.stock <= 5 ? 'âš ï¸' : ''}
                            ${product.stock === 0 ? 'âŒ' : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        function getStockClass(stock) {
            if (stock === 0) return 'stock-out';
            if (stock <= 5) return 'stock-low';
            return '';
        }
        function filterProducts(category, event) {
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            if (event) event.target.classList.add('active');
            renderProducts(category, document.getElementById('barcodeInput').value.trim());
        }
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || product.stock <= 0) return;
            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                if (existingItem.quantity < product.stock) {
                    existingItem.quantity++;
                }
            } else {
                cart.push({...product, quantity: 1});
            }
            updateCartDisplay();
            renderProducts();
            speak(`${product.name} å·²åŠ å…¥è³¼ç‰©è»Š`);
        }
        function updateCartDisplay() {
            const cartItems = document.getElementById('cartItems');
            const cartCount = document.getElementById('cartCount');
            if (cart.length === 0) {
                cartItems.innerHTML = `
                    <div class="empty-cart">
                        <div class="empty-cart-icon">ğŸ›’</div>
                        <p>è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>
                        <p>è«‹é¸æ“‡å•†å“åŠ å…¥è³¼ç‰©è»Š</p>
                    </div>
                `;
                cartCount.textContent = '(0)';
            } else {
                cartItems.innerHTML = cart.map(item => `
                    <div class="cart-item" data-id="${item.id}">
                        <div class="item-info">
                            <div class="item-name">${item.name}</div>
                            <div class="item-price">NT$${item.price} x ${item.quantity}</div>
                        </div>
                        <div class="quantity-controls">
                            <button class="qty-btn" onclick="updateQuantity(${item.id}, -1)">-</button>
                            <span class="quantity">${item.quantity}</span>
                            <button class="qty-btn" onclick="updateQuantity(${item.id}, 1)">+</button>
                            <button class="remove-btn" onclick="removeFromCart(${item.id})">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `).join('');
                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                cartCount.textContent = `(${totalItems})`;
            }
            updateSubtotal();
        }
        function updateQuantity(productId, change) {
            const item = cart.find(item => item.id === productId);
            const product = products.find(p => p.id === productId);
            if (item) {
                const newQuantity = item.quantity + change;
                if (newQuantity <= 0) {
                    removeFromCart(productId);
                } else if (newQuantity <= product.stock) {
                    item.quantity = newQuantity;
                    updateCartDisplay();
                }
            }
        }
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCartDisplay();
        }
        function updateSubtotal() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let discount = 0;
            if (currentMember && currentMember.level === 'VIP') {
                discount = subtotal * currentMember.discount;
            }
            const tax = Math.round((subtotal - discount) * 0.05);
            const total = subtotal - discount + tax;
            document.getElementById('subtotal').textContent = `NT$${subtotal}`;
            document.getElementById('discount').textContent = `-NT$${Math.round(discount)}`;
            document.getElementById('tax').textContent = `NT$${tax}`;
            document.getElementById('total').textContent = `NT$${total}`;
            document.getElementById('checkoutBtn').disabled = cart.length === 0;
        }
        function loginMember() {
            currentMember = memberData;
            const memberInfo = document.getElementById('memberInfo');
            memberInfo.innerHTML = `
                <div class="member-card">
                    <div class="member-info">
                        <div>
                            <div class="member-name">${currentMember.name}</div>
                            <div class="member-details">
                                æ‰‹æ©Ÿï¼š${currentMember.phone}<br>
                                é»æ•¸ï¼š<span id="points">${currentMember.points}</span>é»
                            </div>
                        </div>
                        <div class="member-level">${currentMember.level}</div>
                    </div>
                </div>
                <button class="login-btn" onclick="logoutMember()">ç™»å‡º</button>
                <button class="login-btn" onclick="redeemPoints()">ç”¨ 100 é»æŠ˜æŠµ NT$10</button>
            `;
            updateSubtotal();
        }
        function logoutMember() {
            currentMember = null;
            const memberInfo = document.getElementById('memberInfo');
            memberInfo.innerHTML = `
                <div class="member-login">
                    <p>å°šæœªç™»å…¥æœƒå“¡</p>
                    <button class="login-btn" onclick="loginMember()">æœƒå“¡ç™»å…¥</button>
                </div>
            `;
            updateSubtotal();
        }
        function redeemPoints() {
            if (currentMember && currentMember.points >= 100) {
                currentMember.points -= 100;
                let extraDiscount = 10;
                let subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                let discount = (currentMember.level === 'VIP') ? subtotal * currentMember.discount : 0;
                document.getElementById('discount').textContent = `-NT$${Math.round(discount)+extraDiscount}`;
                document.getElementById('points').textContent = currentMember.points;
                speak('å·²ä½¿ç”¨ 100 é»ç©åˆ†æŠ˜æŠµ NT$10');
                const tax = Math.round((subtotal - discount - extraDiscount) * 0.05);
                const total = subtotal - discount - extraDiscount + tax;
                document.getElementById('tax').textContent = `NT$${tax}`;
                document.getElementById('total').textContent = `NT$${total}`;
            } else {
                speak('é»æ•¸ä¸è¶³ï¼Œç„¡æ³•æŠ˜æŠµ');
            }
        }
        function renderPromotions() {
            const promotionsDiv = document.getElementById('promotions');
            const activePromotions = promotions.filter(p => p.active);
            if (activePromotions.length === 0) {
                promotionsDiv.innerHTML = '<p style="text-align: center; color: #7f8c8d;">æš«ç„¡å„ªæƒ æ´»å‹•</p>';
                return;
            }
            promotionsDiv.innerHTML = activePromotions.map(promo => `
                <div class="promotion-item" onclick="showPromotionDetail('${promo.title}','${promo.description}')">
                    <div class="promotion-title">${promo.title}</div>
                    <div class="promotion-desc">${promo.description}</div>
                </div>
            `).join('');
        }
        function showPromotionDetail(title, desc) {
            alert(`${title}\n\n${desc}`);
            speak(`${title} æ´»å‹•è©³æƒ…å·²é¡¯ç¤º`);
        }
        function selectPayment(type, btn) {
            paymentMethod = type;
            document.querySelectorAll('.pay-method-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            speak(`ä»˜æ¬¾æ–¹å¼å·²é¸æ“‡ï¼š${type}`);
        }
        function checkout() {
            if (cart.length === 0) return;
            const total = document.getElementById('total').textContent;
            const confirmed = confirm(`ç¢ºèªä»¥ã€Œ${paymentMethod}ã€çµå¸³ï¼Ÿ\nç¸½é‡‘é¡ï¼š${total}`);
            if (confirmed) {
                cart.forEach(item => {
                    const product = products.find(p => p.id === item.id);
                    if (product) { product.stock -= item.quantity; }
                });
                cart = [];
                updateCartDisplay();
                renderProducts();
                speak('çµå¸³å®Œæˆï¼Œæ„Ÿè¬æ‚¨çš„æ¶ˆè²»');
                alert('çµå¸³å®Œæˆï¼æ„Ÿè¬æ‚¨çš„æ¶ˆè²»ï¼');
            }
        }
        function printReceipt() {
            if (cart.length === 0) return;
            const printCartList = document.getElementById('print-cart-list');
            printCartList.innerHTML = `
                <table style="width:100%;border-collapse:collapse;">
                    <thead>
                        <tr>
                            <th style="text-align:left;border-bottom:1px solid #bbb;">å•†å“</th>
                            <th style="text-align:right;border-bottom:1px solid #bbb;">å–®åƒ¹</th>
                            <th style="text-align:right;border-bottom:1px solid #bbb;">æ•¸é‡</th>
                            <th style="text-align:right;border-bottom:1px solid #bbb;">å°è¨ˆ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${cart.map(item => `
                            <tr>
                                <td>${item.name}</td>
                                <td style="text-align:right;">NT$${item.price}</td>
                                <td style="text-align:right;">${item.quantity}</td>
                                <td style="text-align:right;">NT$${item.price * item.quantity}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('print-total').innerHTML = document.getElementById('total').outerHTML.replace('id="total"', '');
            document.getElementById('print-area').style.display = 'block';
            window.print();
            setTimeout(() => { document.getElementById('print-area').style.display = 'none'; }, 500);
            speak('åˆ—å°æ˜ç´°å®Œæˆ');
        }
        function speak(text) {
            if (!speechOn) return;
            if ('speechSynthesis' in window) {
                const utter = new SpeechSynthesisUtterance(text);
                utter.lang = 'zh-TW';
                window.speechSynthesis.speak(utter);
            }
        }
        // å•†å“ æ–°å¢/ç·¨è¼¯/åˆªé™¤
        function showProductModal(editId=null) {
            editingProductId = editId;
            let modal = document.getElementById('modal');
            let modalBg = document.getElementById('modalBg');
            let prod = {name:"", price:"", stock:"", category:"é£²å“"};
            if (editId) {
                prod = products.find(p=>p.id===editId);
            }
            modal.innerHTML = `
                <h3>${editId ? 'ç·¨è¼¯å•†å“' : 'æ–°å¢å•†å“'}</h3>
                <form id="productForm" onsubmit="submitProductForm(event)">
                    <label>åç¨±</label>
                    <input type="text" name="name" required value="${prod.name}">
                    <label>åƒ¹æ ¼ (æ–°å°å¹£)</label>
                    <input type="number" name="price" required min="1" value="${prod.price}">
                    <label>åº«å­˜</label>
                    <input type="number" name="stock" required min="0" value="${prod.stock}">
                    <label>åˆ†é¡</label>
                    <select name="category">
                        <option value="é£²å“" ${prod.category==='é£²å“'?'selected':''}>é£²å“</option>
                        <option value="ç”œé»" ${prod.category==='ç”œé»'?'selected':''}>ç”œé»</option>
                        <option value="ä¸»é£Ÿ" ${prod.category==='ä¸»é£Ÿ'?'selected':''}>ä¸»é£Ÿ</option>
                        <option value="å°é£Ÿ" ${prod.category==='å°é£Ÿ'?'selected':''}>å°é£Ÿ</option>
                    </select>
                    <div class="modal-actions">
                        <button type="button" class="cancel-btn" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="ok-btn">${editId ? 'ä¿®æ”¹' : 'æ–°å¢'}</button>
                    </div>
                </form>
            `;
            modalBg.style.display = "flex";
        }
        function submitProductForm(e){
            e.preventDefault();
            let modalBg = document.getElementById('modalBg');
            let f = e.target;
            let data = {
                name: f.name.value.trim(),
                price: parseInt(f.price.value),
                stock: parseInt(f.stock.value),
                category: f.category.value
            };
            if (!data.name || !data.price || data.price <= 0 || data.stock < 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆè³‡æ–™');
                return;
            }
            if (editingProductId) {
                let idx = products.findIndex(p=>p.id===editingProductId);
                products[idx] = {...products[idx], ...data};
                speak('å•†å“å·²ä¿®æ”¹');
            } else {
                let newId = products.length ? Math.max(...products.map(p=>p.id))+1 : 1;
                products.push({...data, id: newId});
                speak('å•†å“å·²æ–°å¢');
            }
            renderProducts(currentProductFilter, currentSearch);
            closeModal();
        }
        function closeModal() {
            document.getElementById('modalBg').style.display = "none";
            editingProductId = null;
        }
        function editProduct(id) {
            showProductModal(id);
        }
        function delProduct(id) {
            if(confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å•†å“ï¼Ÿ")) {
                products = products.filter(p=>p.id!==id);
                speak('å•†å“å·²åˆªé™¤');
                renderProducts(currentProductFilter, currentSearch);
            }
        }
        // æ¢ç¢¼åµæ¸¬
        let barcodeBuffer = "";
        let barcodeTimer;
        document.addEventListener('keydown', function(e) {
            if (document.activeElement.tagName === 'INPUT') return;
            if ((e.key >= '0' && e.key <= '9') || e.key === '-') {
                barcodeBuffer += e.key;
                clearTimeout(barcodeTimer);
                barcodeTimer = setTimeout(() => {
                    if (barcodeBuffer.length >= 4) {
                        const product = products.find(p => p.id == barcodeBuffer || p.name.includes(barcodeBuffer));
                        if (product) {
                            addToCart(product.id);
                            speak('æ¢ç¢¼å•†å“å·²åŠ å…¥è³¼ç‰©è»Š');
                        } else {
                            speak('æœªæ‰¾åˆ°æ¢ç¢¼å•†å“');
                        }
                    }
                    barcodeBuffer = "";
                }, 300);
            }
        });
    </script>
</body>
</html>